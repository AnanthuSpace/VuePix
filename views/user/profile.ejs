<%- include("../partials/userHeader") %>

    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="home" rel="nofollow">Home</a>
                <span></span> Account
            </div>
        </div>
    </div>
    <section class="pt-150 pb-150">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 m-auto">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="dashboard-menu">
                                <ul class="nav flex-column" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab"
                                            href="#dashboard" role="tab" aria-controls="dashboard"
                                            aria-selected="false"><i
                                                class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders"
                                            role="tab" aria-controls="orders" aria-selected="false"><i
                                                class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <!-- <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false"><i class="fi-rs-shopping-cart-check mr-10"></i>Track Your Order</a> -->
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address"
                                            role="tab" aria-controls="address" aria-selected="true"><i
                                                class="fi-rs-marker mr-10"></i>My Address</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab"
                                            href="#account-detail" role="tab" aria-controls="account-detail"
                                            aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="changepass-tab" data-bs-toggle="tab"
                                            href="#changepassword" role="tab" aria-controls="password"
                                            aria-selected="true"><i class="fi-rs-lock mr-10"></i>Change password</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="logout"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content dashboard-content">
                                <div class="tab-pane fade show active" id="dashboard" role="tabpanel"
                                    aria-labelledby="dashboard-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">User Profile</h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <img src="/assets/imgs/theme/user-profile.png"
                                                class="card-img-top rounded-circle mx-auto mt-3" alt="Profile Image"
                                                style="width: 100px; height: 100px; object-fit: cover;">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">
                                                    <%= user.username %>
                                                </h5>
                                                <p class="card-text"><strong>Email:</strong>
                                                    <%= user.email %>
                                                </p>
                                                <p class="card-text"><strong>Phone:</strong>
                                                    <%= user.phone %>
                                                </p>
                                                <p class="card-text"><strong>Account Id:</strong>
                                                    <%= user._id %>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Your Orders</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Order</th>
                                                            <th>Date</th>
                                                            <!-- <th>Status</th> -->
                                                            <th>Total</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% if (order) { %>

                                                            <% for (let i=0; i < order.length; i++) { %>
                                                                <tr>
                                                                    <td>
                                                                        <%= order[i]._id %>
                                                                    </td>

                                                                    <td>
                                                                        <%= order[i].createdOn %>
                                                                    </td>




                                                                    <td>
                                                                        <%= order[i].totalPrice %>
                                                                    </td>


                                                                    <td><a href="/orderDetails?id=<%= order[i]._id %>"
                                                                            class="btn-small d-block">View</a></td>
                                                                </tr>
                                                                <% } %>


                                                                    <% }else{ %>

                                                                        <td>No Orders found</td>

                                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="tab-pane fade" id="track-orders" role="tabpanel"
                                    aria-labelledby="track-orders-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Orders tracking</h5>
                                        </div>
                                        <div class="card-body contact-from-area">
                                            <p>To track your order please enter your OrderID in the box below and press
                                                "Track" button. This was given to you on your receipt and in the
                                                confirmation email you should have received.</p>
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <form class="contact-form-style mt-30 mb-50" action="#"
                                                        method="post">
                                                        <div class="input-style mb-20">
                                                            <label>Order ID</label>
                                                            <input name="order-id"
                                                                placeholder="Found in your order confirmation email"
                                                                type="text" class="square">
                                                        </div>
                                                        <div class="input-style mb-20">
                                                            <label>Billing email</label>
                                                            <input name="billing-email"
                                                                placeholder="Email you used during checkout"
                                                                type="email" class="square">
                                                        </div>
                                                        <button class="submit submit-auto-width"
                                                            type="submit">Track</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div> -->
                                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div class="row">

                                        <%if(userAddress){%>
                                            <%userAddress.address.forEach((address)=>{%>
                                                <div class="col-lg-6">
                                                    <div class="card  mb-3 mb-lg-0">
                                                        <div class="card-header">
                                                            <h5 class="mb-0">
                                                                <%=address.addressType%>
                                                            </h5>
                                                        </div>

                                                        <div class="card-body">
                                                            <address>
                                                                <%=address.name%><br />
                                                                    <%=address.city%>,<br />
                                                                        <%=address.landMark%> <br />
                                                                            <%=address.state%>
                                                            </address>
                                                            <p>
                                                                <%=address.pincode%>
                                                            </p>
                                                            <p>
                                                                <%=address.phone%>
                                                            </p>
                                                            <p>
                                                                <%=address.altPhone%>
                                                            </p>
                                                            <div class="d-flex justify-content-between">
                                                                <a href="/editAddress?id=<%=address._id%>"
                                                                    class="btn-small">Edit</a>
                                                                <a href="/deleteAddress?id=<%=address._id%>"
                                                                    class="btn-small">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <%})%>
                                                    <%}else{%>
                                                        <div class="col-lg-6">
                                                            <div class="card  mb-3 mb-lg-0">
                                                                <div class="card-header">
                                                                    <h5 class="mb-0"></h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <address>
                                                                        No address
                                                                    </address>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <%}%>
                                                            <div>
                                                                <a href="/addAddress">
                                                                    <button class="btn btn-primary w-70">Add
                                                                        address</button>
                                                                </a>
                                                            </div>


                                    </div>
                                </div>

                                <div class="tab-pane fade" id="account-detail" role="tabpanel"
                                    aria-labelledby="account-detail-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Account Details</h5>
                                        </div>
                                        <div class="card-body">

                                            <form method="post" action="/editUserDetails">
                                                <div class="row">
                                                    <div class="form-group col-md-6">
                                                        <label> Name <span class="required">*</span></label>
                                                        <input required="" value="<%= user.username %>"
                                                            class="form-control square" name="name" type="text">
                                                    </div>

                                                    <div class="form-group col-md-12">
                                                        <label>Mobile Number <span class="required">*</span></label>
                                                        <input required="" value="<%= user.phone %>"
                                                            class="form-control square" name="phone" type="text">
                                                    </div>
                                                    <div class="col-md-12 mt-15">
                                                        <button type="submit" class="btn btn-fill-out submit"
                                                            name="submit" value="Submit">Save</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="changepassword" role="tabpanel"
                                    aria-labelledby="changepass-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Change Password</h5>
                                        </div>
                                        <div class="card-body">


                                            <div class="mb-3">
                                                <label for="oldPassword" class="form-label">Old Password:</label>
                                                <input type="password" id="oldPass" class="form-control"
                                                    onkeyup="oldPassword()">
                                                <p class="text-danger" id="oldpass_err"></p>
                                            </div>
                                            <div class="mb-3">
                                                <label for="newPassword" class="form-label">New Password:</label>
                                                <input type="password" id="newPassword" class="form-control"
                                                    onkeyup="newPassword()">
                                                <p class="text-danger" id="newpass_err"></p>
                                            </div>
                                            <div class="mb-3">
                                                <label for="confirmPassword" class="form-label">Confirm New
                                                    Password:</label>
                                                <input type="password" id="confirmPassword" class="form-control"
                                                    onkeyup="confirmPassword()">
                                                <p class="text-danger" id="confirmpass_err"></p>
                                            </div>
                                            <div class="text-center">
                                                <button type="submit" class="btn btn-primary"
                                                    onclick="Check_all(event)">Change
                                                    Password</button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>



    <script>
        const oldpass_err = document.getElementById("oldpass_err");
        const newpass_err = document.getElementById("newpass_err");
        const confirmpass_err = document.getElementById("confirmpass_err");

        function oldPassword() {
            const oldpassword = document.getElementById("oldPass").value;

            if (oldpassword.length < 8) {
                oldpass_err.innerHTML = "Password must be at least 8 characters long";
                oldpass_err.style.display = "block";
                return false;
            } else {
                oldpass_err.style.display = "none";
                oldpass_err.innerHTML = "";
                return true;
            }
        }

        function newPassword() {
            const newpassword = document.getElementById("newPassword").value;
            const oldpassword = document.getElementById("oldPass").value;

            if (newpassword.length < 8) {
                newpass_err.innerHTML = "Password must be at least 8 characters long";
                newpass_err.style.display = "block";
                return false;
            } else if (oldpassword === newpassword) {
                newpass_err.innerHTML = "Passwords must not be the old one";
                newpass_err.style.display = "block";
                return false;
            } else {
                newpass_err.style.display = "none";
                newpass_err.innerHTML = "";
                return true;
            }
        }

        function confirmPassword() {
            const newpassword = document.getElementById("newPassword").value;
            const confirmpassword = document.getElementById("confirmPassword").value;

            if (newpassword !== confirmpassword) {
                confirmpass_err.innerHTML = "Passwords must match as new password";
                confirmpass_err.style.display = "block";
                return false;
            } else {
                confirmpass_err.style.display = "none";
                confirmpass_err.innerHTML = "";
                return true;
            }
        }

        document.getElementById("oldPass").addEventListener("keyup", oldPassword);
        document.getElementById("newPassword").addEventListener("keyup", newPassword);
        document.getElementById("confirmPassword").addEventListener("keyup", confirmPassword);


        function Check_all() {
            const oldpassword = document.getElementById("oldPass").value;
            const newpassword = document.getElementById("newPassword").value;
            if (!oldPassword() || !newPassword() || !confirmPassword()) {
                e.preventDefault()
                return false;

            } else {
                $.ajax({

                    url: `/changepassword`,
                    method: 'post',
                    data: {
                        oldPass: oldpassword,
                        newPass: newpassword
                    },
                    success: function (response) {
                        console.log(response);
                        if (response.status === true) {
                            Swal.fire({
                                title: 'Reset Password',
                                text: 'Password changed.',
                                icon: 'success',
                                timer: 5000
                            }).then(() => {
                                location.reload()

                            })

                        } else if (response.status === false) {
                            Swal.fire({
                                title: 'Reset Password',
                                text: 'Current Password is not correct.',
                                icon: 'error',
                                timer: 5000
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: 'An unexpected error occurred.',
                                icon: 'error',
                                timer: 5000
                            });
                        }
                    }
                });
            }
        }

    </script>





    <%- include("../partials/userFooter") %>